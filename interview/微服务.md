#微服务
    微服务设计
    gRPC & 服务发现
    多集群 & 多租户
    References


### 什么是微服务？
  
      微服务-也称为微服务架构-是一种架构样式，可将应用程序构造为一组服务，这些服务包括
        1.高度可维护和可测试
        2.松耦合
        3.可独立部署
        4.围绕业务能力进行组织
        5.由一个小团队拥有
        微服务架构可以快速，频繁且可靠地交付大型，复杂的应用程序。它还使组织能够发展其技术堆栈。
        
        微服务架构即是采用一组小服务来构建应用的方法。
        每个服务运行在独立的进程中，不同服务通过一些轻量级交互机制来通信， 例如 RPC、HTTP 等。
        服务围绕业务能力来构建，并依赖自动部署机制来独立部署。
        
        
#### 优点
        
        小即是美：小的服务代码少，bug 也少，易测试，易维护，也更容易不断迭代完善的精致进而美妙。
        一个程序只做好一件事：一个服务也只需要做好一件好，专注才能做好。
        尽可能早地创建原型：尽可能早的提供服务 API，建立服务契约，达成服务间沟通的一致性约定，至于实现和完善可以慢慢再做。
        可移植性比效率更重要：服务间的轻量级交互协议在效率和可移植性二者间，首要依然考虑兼容性和移植性。




#### 微服务架构的不足
     
   <https://my.oschina.net/CraneHe/blog/703181>
     
         1.微服务应用是分布式系统，由此会带来固有的复杂性。开发者不得不使用 RPC 或者消息传递来实现进程间通信；此外，必须要写代码来处理消息传递中速度过慢或者服务不可用等局部失效问题。
         2.分区的数据库架构，同时更新多个业务主体的事务很普遍。这种事务对于单体式应用来说很容易，因为只有一个数据库。在微服务架构应用中，需要更新不同服务所使用的不同的数据库，从而对开发者提出了更高的要求和挑战。
         3.测试一个基于微服务架构的应用也是很复杂的任务。
         4.服务模块间的依赖，应用的升级有可能会波及多个服务模块的修改。
         5.对运维基础设施的挑战比较大。

         
               
        
####  微服务架构~BFF和网关是如何演化出来的 
   <https://www.cnblogs.com/dadadechengzi/p/9373069.html>      
       
        **BFF(Backend for Frontend)和网关Gateway是微服务架构中的两个重要概念**         
        所谓BFF其实是Backend for Frontend的简称，中文翻译是为前端而开发的后端，它主要由前端团队开发（后端微服务一般由后端团队开发）。BFF可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），向无线端设备暴露友好和统一的API，方便无线设备接入访问后端服务。
        
        `1. BFF按团队或业务线进行解耦拆分，拆分成若干个BFF微服务，每个业务线可以并行开发和交付各自负责的BFF微服务。
         
         2. 网关（一般由独立框架团队负责运维）专注跨横切面(Cross-Cutting Concerns)的功能，包括：
         
             路由，将来自无线设备的请求路由到后端的某个微服务BFF集群。
             
             认证，对涉及敏感数据的API访问进行集中认证鉴权。
             
             监控，对API调用进行性能监控。
             
             限流熔断，当出现流量洪峰，或者后端BFF/微服务出现延迟或故障，网关能够主动进行限流熔断，保护后端服务，并保持前端用户体验可以接受。
             
             安全防爬，收集访问日志，通过后台分析出恶意行为，并阻断恶意请求。`
         
         端用户体验层->网关层->BFF层->微服务层 
        
        
        
        
        

#### API Gateway
        API Gateway是一个服务器，也可以说是进入系统的唯一节点

        API Gateway封装内部系统的架构，并且提供API给各个客户端。它还可能有其他功能，如授权、监控、负载均衡、缓存、请求分片和管理、静态响应处理等。

        API Gateway负责请求转发、合成和协议转换。所有来自客户端的请求都要先经过API Gateway，然后路由这些请求到对应的微服务。API Gateway将经常通过调用多个微服务来处理一个请求以及聚合多个服务的结果。它可以在web协议与内部使用的非Web友好型协议间进行转换，如HTTP协议、WebSocket协议。 

###### API Gateway的优点和缺点

            采用API Gateway也是优缺点并存的。
            1.API Gateway的一个最大好处是封装应用内部结构。相比起来调用指定的服务，客户端直接跟gatway交互更简单点。API Gateway提供给每一个客户端一个特定API，这样减少了客户端与服务器端的通信次数，也简化了客户端代码。
            
            2.API Gateway也有一些缺点。它是一个高可用的组件，必须要开发、部署和管理。还有一个问题，它可能成为开发的一个瓶颈。开发者必须更新API Gateway来提供新服务提供点来支持新暴露的微服务。更新API Gateway时必须越轻量级越好。否则，开发者将因为更新Gateway而排队列。但是，除了这些缺点，对于大部分的应用，采用API Gateway的方式都是有效的。
            
      
       
               
#### 负载均衡
    LVS（Linux Virtual Server）即Linux虚拟服务器
    DNS + LVS 经典解决办法 集中式
    问题: 单点问题 
    
    负载均衡：
        1.解决单点
        2.方便扩展
    
    Nginx 反向代理  
    1 轮询  2 加权 3 ip_hash 4 url_hash  5 fair
    
    负载均衡算法：
        随机  加权  轮询  hash
    
  
  
#### 微服务框架的意义(专业的人做专业的事)
    1.性能
    2.稳定性
    3.效率 
 
	共性问题
	    客户端RPC
	        链接
	        超时
	        
	     网络传输
	    
	    框架问题
	    
	
#### http2
	1.多路复用
	2.二进制分帧
	3.头部压缩
	4.服务推送
	
	Grpc
	   go使用https 就默认http2
	    客户端兼容http1.1 协商算法ALPN
	    TLS/SSL
	    
	
	http
	    信息不安全
	    容易被截取
	    容易被篡改
	    劫持
	    
	对称（密钥相同）
	    性能好
	    ············                                                                             
	 
	非对称（加密密钥） + 对称加密 
	 
    https
        数字认证
            认证中心	 



   	
#### Prometheus  Grafana(可视化图表)
    分布式监控系统
    完全开源 使用Go开发
    应用监控云计算基础架构
    
    底层也是时序数据库 
    
    采用拉模式（pull）  -- 服务发现
    短任务 也支持push 	
	
	key - value  +  标签
	
	度量类型
	    计数器Counter采样
	        随时间增加的计算元素
	        只增
	         
	    Gauges   
	      处理随时间减少的值
	     
	     
	    Histogram柱状图
	        对每个采样点进行统计（并不是一段时间的统计）
	        累计和sum  and  count
	        
	        
        summary采样
            在客户端对一段时间内的每个采样点统计
            分位图	百分比分布
	
	
	安装和配置
	    https://promethues.io
	    9090         
	    配置文件 --- 配置    
	
	
	Grafana(可视化图表) 
	    go开发  开源的
	    
	    数据源 ： influxDB  ES  mysql等
	    
	    配置数据源
	        Prometheus
	        
	    
	Prometheus项目中使用
	    提供了go的接口
	    基本的使用
	       
	metries埋点
	
	       
	       
	       
####	 Yaml
    基本语法
        大小敏感
        使用缩进表示层级
        缩进不允许Tab
        
    对象
        数组 字典 哈希
        
    数组
        - cat
        - dog
        对应json [cat, dog]
    纯量       
	    字符串 布尔 浮点 时间 日期    
	支持复杂组合       
	       
	       
	       
####	限流中间件
    限制介绍
        应对突发大流量
            --类似水库         
            --景区限流
                解决：排队 限购
                
            
       技术限流算法
          计数器
             -- 时间单位内 重新计数 拒绝访问
                时间戳
             缺点：
                出现毛刺现象
                技术不准确
          -
          漏桶：
             -- 一个固定的水桶 以固定流速
                  不满则处理   
          -   
          令牌桶：（最主流）	       
             -- 一个固定的桶 以固定速度放入token
                拿到token则处理
             取不做限制 应对突发大流量  
               
	       
	  分布式的限流 ---  redis             
        
        
        
        
#### 多集群 & 多租户        
        
   <https://mp.weixin.qq.com/s/L6OKJK1ev1FyVDu03CQ0OA>
        
        
        
        
#### Microservices 安全        
        
        对于外网的请求来说，我们通常在 API Gateway 进行统一的认证拦截，一旦认证成功，我们会使用 JWT 方式通过 RPC 元数据传递的方式带到 BFF 层，BFF 校验 Token 完整性后把身份信息注入到应用的 Context 中，BFF 到其他下层的微服务，建议是直接在 RPC Request 中带入用户身份信息(UserID)请求服务。
        API Gateway -> BFF -> Service
        Biz Auth  -> JWT -> Request Args
        
        
        对于服务内部，一般要区分身份认证和授权。
        Full Trust
        Half Trust
        Zero Trust
     
        
        
        
#### 通信  
        
        http
        rpc             
            >grpc  
                1.多语言：语言中立，支持多种语言。
                2.轻量级、高性能：序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架。
                可插拔
                3.IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。
                设计理念
                4.移动端：基于标准的 HTTP/2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。     
                    
                    
                    1.服务而非对象、消息而非引用：促进微服务的系统间粗粒度消息交互设计理念。
                    2.负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。
                    3.流：Streaming API。
                    4.阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。
                    5.元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。
                    6.标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误。
           
            >thrift
            
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
               